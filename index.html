<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPD - PE</title>
    <link rel="icon" href="icons/icon-192x192.png" type="image/png" />

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="icons/icon-180x180.png">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        body { box-sizing: border-box; }
        .thai-font { font-family: 'Sarabun', 'Noto Sans Thai', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error-type-btn {
            padding: 1rem 1.5rem; margin: 0.5rem; font-size: 1.1rem;
            font-weight: 600; border: none; border-radius: 0.75rem;
            cursor: pointer; transition: all 0.2s ease-in-out;
            width: 100%; color: white;
        }
        .error-type-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .swal2-input, .swal2-select {
            border: 1px solid #d1d5db !important; border-radius: 0.5rem !important;
            font-size: 1rem !important; height: auto !important;
            padding: 0.75rem 1rem !important;
        }
        .delete-button .trash-lid { transform-origin: top right; transition: transform 0.3s ease-in-out; }
        .delete-button:hover .trash-lid { transform: rotate(-45deg) translateY(-2px) translateX(1px); }
        
        /* --- IMPROVED SEARCHABLE DROPDOWN STYLES --- */
        .clinic-search-container { position: relative; width: 100%; }
        
        #clinic-search-input {
             padding: 0.75rem 1rem !important;
             border: 1px solid #d1d5db !important;
             border-radius: 0.5rem !important;
             box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
             width: 100%;
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        #clinic-search-input:focus {
             outline: none;
             border-color: #3b82f6 !important;
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3) !important;
        }

        .clinic-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; 
            z-index: 99999; 
            background: white; 
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            margin-top: 2px;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .clinic-dropdown-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            font-size: 1rem;
        }
        .clinic-dropdown-item:hover, .clinic-dropdown-item.highlighted { 
            background-color: #eef2ff;
            color: #4338ca;
            font-weight: 500;
        }
        .clinic-dropdown-empty {
             padding: 0.8rem 1rem;
             color: #6b7280;
             text-align: center;
        }

        /* --- SCANNER STYLES --- */
        #scanner-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        #scanner-container video, #scanner-container canvas {
            width: 100%;
            height: auto;
        }
        #scanner-container canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        .scanner-laser {
            position: absolute;
            left: 0;
            top: 50%;
            right: 0;
            height: 2px;
            background-color: red;
            box-shadow: 0 0 5px red;
            transform: translateY(-50%);
            z-index: 10;
        }

        /* --- NEW LOADER STYLES --- */
        .pl {
            width: 6em;
            height: 6em;
        }
        .pl__ring {
            animation: ringA 2s linear infinite;
        }
        .pl__ring--a { stroke: #f42f25; }
        .pl__ring--b { animation-name: ringB; stroke: #f49725; }
        .pl__ring--c { animation-name: ringC; stroke: #255ff4; }
        .pl__ring--d { animation-name: ringD; stroke: #f42582; }

        @keyframes ringA {
            from, 4% { stroke-dasharray: 0 660; stroke-width: 20; stroke-dashoffset: -330; }
            12% { stroke-dasharray: 60 600; stroke-width: 30; stroke-dashoffset: -335; }
            32% { stroke-dasharray: 60 600; stroke-width: 30; stroke-dashoffset: -595; }
            40%, 54% { stroke-dasharray: 0 660; stroke-width: 20; stroke-dashoffset: -660; }
            62% { stroke-dasharray: 60 600; stroke-width: 30; stroke-dashoffset: -665; }
            82% { stroke-dasharray: 60 600; stroke-width: 30; stroke-dashoffset: -925; }
            90%, to { stroke-dasharray: 0 660; stroke-width: 20; stroke-dashoffset: -990; }
        }
        @keyframes ringB {
            from, 12% { stroke-dasharray: 0 220; stroke-width: 20; stroke-dashoffset: -110; }
            20% { stroke-dasharray: 20 200; stroke-width: 30; stroke-dashoffset: -115; }
            40% { stroke-dasharray: 20 200; stroke-width: 30; stroke-dashoffset: -195; }
            48%, 62% { stroke-dasharray: 0 220; stroke-width: 20; stroke-dashoffset: -220; }
            70% { stroke-dasharray: 20 200; stroke-width: 30; stroke-dashoffset: -225; }
            90% { stroke-dasharray: 20 200; stroke-width: 30; stroke-dashoffset: -305; }
            98%, to { stroke-dasharray: 0 220; stroke-width: 20; stroke-dashoffset: -330; }
        }
        @keyframes ringC {
            from { stroke-dasharray: 0 440; stroke-width: 20; stroke-dashoffset: 0; }
            8% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -5; }
            28% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -175; }
            36%, 58% { stroke-dasharray: 0 440; stroke-width: 20; stroke-dashoffset: -220; }
            66% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -225; }
            86% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -395; }
            94%, to { stroke-dasharray: 0 440; stroke-width: 20; stroke-dashoffset: -440; }
        }
        @keyframes ringD {
            from, 8% { stroke-dasharray: 0 440; stroke-width: 20; stroke-dashoffset: 0; }
            16% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -5; }
            36% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -175; }
            44%, 50% { stroke-dasharray: 0 440; stroke-width: 20; stroke-dashoffset: -220; }
            58% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -225; }
            78% { stroke-dasharray: 40 400; stroke-width: 30; stroke-dashoffset: -395; }
            86%, to { stroke-dasharray: 0 440; stroke-width: 20; stroke-dashoffset: -440; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full thai-font">
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50" style="display: none;">
        <div class="text-center">
             <!-- New SVG Loader -->
            <svg class="pl mx-auto" width="120" height="120" viewBox="0 0 240 240">
                <circle class="pl__ring pl__ring--a" cx="120" cy="120" r="105" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 660" stroke-dashoffset="-330" stroke-linecap="round"></circle>
                <circle class="pl__ring pl__ring--b" cx="120" cy="120" r="35" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 220" stroke-dashoffset="-110" stroke-linecap="round"></circle>
                <circle class="pl__ring pl__ring--c" cx="85" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
                <circle class="pl__ring pl__ring--d" cx="155" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
            </svg>
            <p class="mt-4 text-gray-700 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="container mx-auto px-4 py-6 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Prescribing Error</h1>
            <p class="text-blue-600 text-sm md:text-base">‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå</p>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-blue-600 shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex justify-center space-x-1">
                <button onclick="showPage('record')" id="recordTab" class="px-6 py-3 text-white font-medium transition-all duration-200 border-b-2 border-transparent hover:bg-blue-700 focus:outline-none">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="showPage('report')" id="reportTab" class="px-6 py-3 text-white font-medium transition-all duration-200 border-b-2 border-transparent hover:bg-blue-700 focus:outline-none">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="recordPage" class="container mx-auto px-4 py-8 max-w-2xl"></div>
    <div id="reportPage" class="container mx-auto px-4 py-8 hidden"></div>

    <!-- Footer -->
    <footer class="text-center py-4">
        <p id="syncStatus" class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
    </footer>

    <script>
        // --- PWA Service Worker Registration (Optional) ---
        if ('serviceWorker' in navigator) { 
            window.addEventListener('load', () => { 
                navigator.serviceWorker.register('sw.js').catch(err => console.log('Service Worker registration failed: ', err)); 
            }); 
        }

        // --- Configuration ---
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwRXhaSc12Qb-SZGE7Lo1hkeRYbUDsRDkAHyqlfDjkLxkpL_eimtLOJOZC6Ky6osFHF/exec'; 
        
        // --- Global State ---
        let medErrorData = [];
        let clinics = ['‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å', '‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó', '‡∏™‡∏π‡∏ï‡∏¥-‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä', '‡πÇ‡∏£‡∏Ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏î', '‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á', '‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô']; // Default clinics
        const errorTypes = ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î', '‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î', '‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ off'];
        let chart = null, pieChart = null, clinicChart = null;
        let isSyncing = false;
        let recentRecordsPage = 0, dataTablePage = 0;
        let currentFilteredData = [];
        const RECENT_ITEMS_PER_PAGE = 10;
        const DATA_TABLE_ITEMS_PER_PAGE = 20;
        let highlightedIndex = -1; 

        // --- Chart.js Setup ---
        Chart.register(ChartDataLabels);

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            medErrorData = JSON.parse(localStorage.getItem('medErrorData')) || [];
            const storedClinics = JSON.parse(localStorage.getItem('clinics')) || [];
            if (storedClinics.length > 0) {
                clinics = storedClinics;
            }
            currentFilteredData = [...medErrorData];
            showPage('record'); 
            await fetchDataFromSheet(); 
        });

        // --- Data Fetching ---
        async function fetchDataFromSheet() {
            if (isSyncing) return;
            isSyncing = true;
            showLoading(true);
            document.getElementById('syncStatus').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            try {
                const response = await fetch(scriptURL);
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const rawData = (result.data.pe || []);
                    medErrorData = rawData.map(record => {
                        const recordDate = new Date(record.timestamp);
                        return {
                            ...record,
                            date: formatDateToThaiString(recordDate),
                            time: formatTimeToThaiString(recordDate)
                        };
                    }).sort((a, b) => b.id - a.id); 

                    clinics = result.data.clinics || clinics;
                    localStorage.setItem('medErrorData', JSON.stringify(medErrorData));
                    localStorage.setItem('clinics', JSON.stringify(clinics));
                    updateUIAfterFetch();
                    document.getElementById('syncStatus').textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleTimeString('th-TH')}`;
                } else { 
                    throw new Error(result.message || 'Unknown server error'); 
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                const errorMessage = error.toString();
                
                if (errorMessage.includes('getDataRange') || errorMessage.includes('getSheetByName') || errorMessage.includes('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏ä‡∏∑‡πà‡∏≠')) {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡∏µ‡∏ó',
                        html: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó <b>"Data"</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>"Clinics"</b> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏¥‡∏î<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`,
                        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
                    });
                    document.getElementById('syncStatus').textContent = '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏µ‡∏ó‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ', 'error');
                    document.getElementById('syncStatus').textContent = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
                }
            } finally { 
                isSyncing = false; 
                showLoading(false); 
            }
        }
        
        // --- Page Navigation ---
        function showPage(page) {
            document.getElementById('recordPage').style.display = 'none';
            document.getElementById('reportPage').style.display = 'none';
            
            if (page === 'record') { 
                renderRecordPage(); 
                document.getElementById('recordPage').style.display = 'block'; 
            } else { 
                renderReportPage(); 
                document.getElementById('reportPage').style.display = 'block'; 
                loadReportData(); 
            }
            
            const recordTab = document.getElementById('recordTab');
            const reportTab = document.getElementById('reportTab');
            if(recordTab) recordTab.classList.toggle('bg-blue-700', page === 'record');
            if(reportTab) reportTab.classList.toggle('bg-blue-700', page === 'report');
        }
        
        // --- UI Rendering ---
        function renderRecordPage() {
            document.getElementById('recordPage').innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-6 md:p-8 fade-in relative">
                    <button onclick="showAddClinicModal()" class="absolute top-4 right-4 bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm font-bold py-2 px-3 rounded-lg transition-colors">
                        Add Clinic
                    </button>
                    <div class="text-center mb-8">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"><span class="text-2xl">üè•</span></div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Med Error</h2>
                    </div>
                    <form onsubmit="showErrorTypeModal(event)" class="space-y-6">
                        <div>
                            <label for="hnInput" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="hnInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg text-center" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô HN" required>
                                <button type="button" onclick="startScanner()" class="p-3 bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors" aria-label="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </form>
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-lg font-semibold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                             <div class="flex items-center space-x-2">
                                 <button id="prevRecentBtn" onclick="prevRecentPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                                 <span id="recentPageIndicator" class="text-sm text-gray-600 font-medium w-20 text-center"></span>
                                 <button id="nextRecentBtn" onclick="nextRecentPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                             </div>
                         </div>
                        <div id="recentRecords" class="space-y-2"></div>
                    </div>
                </div>`;
            updateRecentRecords();
        }

        function renderReportPage() {
             const today = new Date().toISOString().split('T')[0];
             const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
             const clinicOptions = clinics.map(c => `<option value="${c}">${c}</option>`).join('');
             const errorTypeOptions = errorTypes.map(e => `<option value="${e}">${e}</option>`).join('');
             document.getElementById('reportPage').innerHTML = `<div class="space-y-6">
                <!-- Filter Section -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 sm:mb-0">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                        <button type="button" onclick="fetchDataFromSheet()" class="flex justify-center gap-2 items-center shadow-xl text-sm bg-gray-50 backdrop-blur-md font-semibold isolation-auto border-gray-50 before:absolute before:w-full before:transition-all before:duration-700 before:hover:w-full before:-left-full before:hover:left-0 before:rounded-full before:bg-emerald-500 hover:text-gray-50 before:-z-10 before:aspect-square before:hover:scale-150 before:hover:duration-700 relative z-10 px-4 py-2 overflow-hidden border-2 rounded-full group">
                            Refresh
                            <svg class="w-6 h-6 justify-end group-hover:rotate-90 group-hover:bg-gray-50 text-gray-50 ease-linear duration-300 rounded-full border border-gray-700 group-hover:border-none p-1 rotate-45" viewBox="0 0 16 19" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7 18C7 18.5523 7.44772 19 8 19C8.55228 19 9 18.5523 9 18H7ZM8.70711 0.292893C8.31658 -0.0976311 7.68342 -0.0976311 7.29289 0.292893L0.928932 6.65685C0.538408 7.04738 0.538408 7.68054 0.928932 8.07107C1.31946 8.46159 1.95262 8.46159 2.34315 8.07107L8 2.41421L13.6569 8.07107C14.0474 8.46159 14.6805 8.46159 15.0711 8.07107C15.4616 7.68054 15.4616 7.04738 15.0711 6.65685L8.70711 0.292893ZM9 18L9 1H7L7 18H9Z" class="fill-gray-800 group-hover:fill-gray-800"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${weekAgo}"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${today}"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Error</label><select id="errorTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${errorTypeOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label><select id="clinicFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${clinicOptions}</select></div>
                        <div><button onclick="filterData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">üîç ‡∏Å‡∏£‡∏≠‡∏á</button></div>
                    </div>
                </div>
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-3xl mb-2">üìä</div><div class="text-2xl font-bold text-blue-600" id="totalErrors">0</div><div class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</div></div>
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-3xl mb-2">üìÖ</div><div class="text-2xl font-bold text-green-600" id="todayErrors">0</div><div class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div>
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-3xl mb-2">üìà</div><div class="text-2xl font-bold text-orange-600" id="avgDaily">0</div><div class="text-gray-600">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div></div>
                </div>
                <!-- Charts -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">üì• Export Excel</button>
                    </div>
                    <div class="h-80"><canvas id="errorChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Error</h3>
                        <div class="h-80 w-full max-w-md mx-auto"><canvas id="pieChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">üè• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Error ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h3>
                        <div class="h-80 w-full mx-auto"><canvas id="clinicBarChart"></canvas></div>
                    </div>
                </div>
                <!-- Data Table -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                        <div class="flex items-center space-x-2">
                            <button id="prevDataBtn" onclick="prevDataPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <span id="dataPageIndicator" class="text-sm text-gray-600 font-medium w-20 text-center"></span>
                            <button id="nextDataBtn" onclick="nextDataPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="dataTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }
        
        // --- Barcode Scanner Logic ---
        const handleScannerProcessed = (result) => {
            const drawingCtx = Quagga.canvas.ctx.overlay;
            const drawingCanvas = Quagga.canvas.dom.overlay;
            if (!drawingCtx || !drawingCanvas) return;
            drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
            if (result && result.boxes) {
                result.boxes.filter(box => box !== result.box).forEach(box => {
                    Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                });
            }
            if (result && result.box) Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
            if (result && result.codeResult && result.codeResult.code) Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
        };

        const handleScannerDetected = (result) => {
            const code = result.codeResult.code;
            Quagga.stop();
            Quagga.offProcessed(handleScannerProcessed);
            Quagga.offDetected(handleScannerDetected);

            Swal.fire({
                title: '‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏≠: ${code}`, icon: 'success',
                showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà'
            }).then((dialogResult) => {
                 if(dialogResult.isConfirmed) {
                    document.getElementById('hnInput').value = code;
                    Swal.close();
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å HN: ${code}`, 'success');
                 } else if (dialogResult.dismiss === Swal.DismissReason.cancel) {
                    startScanner();
                 }
            });
        };

        function startScanner() {
            Swal.fire({
                title: '‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î HN',
                html: `<div id="scanner-container"><div class="scanner-laser"></div></div><p class="mt-2 text-sm text-gray-600">‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö</p>`,
                showConfirmButton: false, showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                didOpen: () => {
                    Quagga.init({
                        inputStream: {
                            name: "Live", type: "LiveStream", target: document.querySelector('#scanner-container'),
                            constraints: { width: 640, height: 480, facingMode: "environment" },
                        },
                        locator: { patchSize: "medium", halfSample: true },
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        decoder: { readers: ["code_128_reader", "code_39_reader"], multiple: false },
                        locate: true
                    }, (err) => {
                        if (err) {
                            console.error(err);
                            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
                            return;
                        }
                        Quagga.onProcessed(handleScannerProcessed);
                        Quagga.onDetected(handleScannerDetected);
                        Quagga.start();
                    });
                },
                willClose: () => {
                    Quagga.offProcessed(handleScannerProcessed);
                    Quagga.offDetected(handleScannerDetected);
                    Quagga.stop();
                }
            });
        }

        // --- Data Actions & Modals ---
        function showErrorTypeModal(event) {
            event.preventDefault();
            const hn = document.getElementById('hnInput').value.trim();
            if (!hn) return;
            Swal.fire({
                title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å HN: ${hn}`,
                html: `<p class="text-gray-600 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô</p><div class="grid grid-cols-1 sm:grid-cols-3 gap-2"><button onclick="showClinicModal('${hn}', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î')" class="error-type-btn bg-teal-500">‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î</button><button onclick="showClinicModal('${hn}', '‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î')" class="error-type-btn bg-pink-500">‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î</button><button onclick="showClinicModal('${hn}', '‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ off')" class="error-type-btn bg-indigo-500">‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ off</button></div>`,
                showConfirmButton: false, showCancelButton: true,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });
        }

        // --- DATE/TIME HELPER FUNCTIONS ---
        function formatDateToThaiString(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear() + 543;
            return `${day}/${month}/${year}`;
        }

        function formatTimeToThaiString(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function showClinicModal(hn, errorType) {
            highlightedIndex = -1; 
            const outsideClickListener = (e) => {
                const container = document.getElementById('searchable-dropdown-container');
                if (container && !container.contains(e.target)) {
                    const dropdown = document.getElementById('clinic-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                }
            };
            const keydownListener = (e) => handleDropdownKeys(e);

            Swal.fire({
                title: `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HN: ${hn}`,
                html: `
                    <p class="text-gray-500 mb-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: <strong>${errorType}</strong></p>
                    <div id="searchable-dropdown-container" class="text-left" style="margin-bottom: 10rem;">
                         <label for="clinic-search-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label>
                         <div class="clinic-search-container">
                            <input id="clinic-search-input" autocomplete="off" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å...">
                            <div id="clinic-dropdown" class="clinic-dropdown hidden"></div>
                        </div>
                    </div>`,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', cancelButtonText: '‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö',
                stopKeydownPropagation: false,
                didOpen: () => {
                    const popup = Swal.getPopup();
                    const container = Swal.getHtmlContainer();
                    if (popup) popup.style.overflow = 'visible';
                    if (container) container.style.overflow = 'visible';

                    const input = document.getElementById('clinic-search-input');
                    input.addEventListener('focus', filterClinics);
                    input.addEventListener('keyup', (e) => { 
                        if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown' && e.key !== 'Enter') filterClinics();
                    });
                    input.addEventListener('keydown', keydownListener);
                    document.addEventListener('click', outsideClickListener);
                    filterClinics();
                    input.focus();
                },
                willClose: () => {
                    document.removeEventListener('click', outsideClickListener);
                    const input = document.getElementById('clinic-search-input');
                    if(input) input.removeEventListener('keydown', keydownListener);
                    const popup = Swal.getPopup();
                     if (popup) popup.style.overflow = 'auto';
                },
                preConfirm: () => {
                    const clinic = document.getElementById('clinic-search-input').value.trim();
                    if (!clinic) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å'); return false; }
                    return { hn, errorType, clinic };
                }
            }).then((result) => {
                if (result.isConfirmed) { 
                    saveError(result.value.hn, result.value.errorType, result.value.clinic); 
                } else if (result.dismiss === Swal.DismissReason.cancel) { 
                    showErrorTypeModal({ preventDefault: () => {} }); 
                }
            });
        }
        
        function handleDropdownKeys(e) {
            const dropdown = document.getElementById('clinic-dropdown');
            if (!dropdown || dropdown.classList.contains('hidden')) return;

            const items = dropdown.getElementsByClassName('clinic-dropdown-item');
            if (!items.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightedIndex = (highlightedIndex + 1) % items.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightedIndex = (highlightedIndex - 1 + items.length) % items.length;
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedIndex > -1 && items[highlightedIndex]) {
                    items[highlightedIndex].click();
                } else {
                    Swal.clickConfirm();
                }
                return;
            }
            updateHighlight(items);
        }

        function updateHighlight(items) {
             for (let i = 0; i < items.length; i++) items[i].classList.remove('highlighted');
             if(items[highlightedIndex]) {
                items[highlightedIndex].classList.add('highlighted');
                items[highlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        async function showAddClinicModal() {
            const existingClinicsHtml = `
                <div class="text-left mt-4 p-3 bg-gray-50 rounded-lg border max-h-40 overflow-y-auto">
                    <h4 class="font-semibold text-gray-700 mb-2 text-sm">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß:</h4>
                    <ul class="list-disc list-inside text-gray-600 text-sm space-y-1">
                        ${[...clinics].sort().map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>
            `;

            const { value: newClinic } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà',
                input: 'text',
                inputLabel: '‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å',
                inputPlaceholder: '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å...',
                html: existingClinicsHtml,
                showCancelButton: true,
                confirmButtonText: '‡πÄ‡∏û‡∏¥‡πà‡∏°',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => {
                    if (!value) {
                        return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å';
                    }
                }
            });

            if (newClinic && newClinic.trim()) {
                const trimmedClinic = newClinic.trim();
                if (clinics.some(c => c.toLowerCase() === trimmedClinic.toLowerCase())) {
                    showNotification('‡∏°‡∏µ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return;
                }
                showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å...', 'info');
                const result = await sendToGoogleSheets('addClinic', { clinicName: trimmedClinic });
                if (result && result.status === 'success') {
                    clinics.push(trimmedClinic);
                    clinics.sort();
                    localStorage.setItem('clinics', JSON.stringify(clinics));
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else { showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); }
            }
        }

        function filterClinics() {
            const input = document.getElementById('clinic-search-input');
            const dropdown = document.getElementById('clinic-dropdown');
            if (!input || !dropdown) return;
            highlightedIndex = -1; 
            const filter = input.value.toLowerCase();
            const filteredClinics = clinics.filter(c => c.toLowerCase().includes(filter));
            dropdown.innerHTML = filteredClinics.length > 0
                ? filteredClinics.map(c => `<div class="clinic-dropdown-item" onclick="selectClinic('${c}')">${c}</div>`).join('')
                : `<div class="clinic-dropdown-empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</div>`;
            dropdown.classList.remove('hidden');
        }

        function selectClinic(clinicName) {
            document.getElementById('clinic-search-input').value = clinicName;
            document.getElementById('clinic-dropdown').classList.add('hidden');
            Swal.clickConfirm(); 
        }
        
        function saveError(hn, errorType, clinic) {
            const now = new Date();
            const record = { 
                id: now.getTime(), 
                hn, errorType, clinic, 
                timestamp: now.toISOString(), 
                date: formatDateToThaiString(now), 
                time: formatTimeToThaiString(now) 
            };
            medErrorData.unshift(record);
            recentRecordsPage = 0;
            updateUIAfterFetch();
            document.getElementById('hnInput').value = '';
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            sendToGoogleSheets('addRecord', record).then(result => {
                if (!result || result.status !== 'success') {
                    console.error("Sync failed, rolling back.", result);
                    if (result && result.status === 'duplicate') { 
                        Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥', text: `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Error ‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á HN: ${hn} ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß` }); 
                    } else { 
                        showNotification('‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); 
                    }
                    medErrorData = medErrorData.filter(r => r.id !== record.id);
                    updateUIAfterFetch();
                }
            });
        }
        
        function editRecord(recordId) {
            const record = medErrorData.find(r => r.id === recordId);
            if (!record) return;
            const errorOptionsHtml = errorTypes.map(type => `<option value="${type}" ${record.errorType === type ? 'selected' : ''}>${type}</option>`).join('');
            const clinicOptionsHtml = clinics.map(c => `<option value="${c}" ${record.clinic === c ? 'selected' : ''}>${c}</option>`).join('');
            Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                html: `<div class="space-y-4 p-2 text-center"><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN</label><input id="swal-hn-input" class="swal2-input w-full" value="${record.hn}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="swal-error-type-select" class="swal2-select w-full">${errorOptionsHtml}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label><select id="swal-clinic-select" class="swal2-select w-full">${clinicOptionsHtml}</select></div></div>`,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                preConfirm: () => {
                    const newHn = document.getElementById('swal-hn-input').value.trim();
                    if (!newHn) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN'); return false; }
                    return { newHn, newErrorType: document.getElementById('swal-error-type-select').value, newClinic: document.getElementById('swal-clinic-select').value };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { newHn, newErrorType, newClinic } = result.value;
                    const updatedRecord = { ...record, hn: newHn, errorType: newErrorType, clinic: newClinic };
                    medErrorData = medErrorData.map(r => r.id === recordId ? updatedRecord : r);
                    updateUIAfterFetch();
                    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...', 'info');
                    sendToGoogleSheets('editRecord', { id: recordId, hn: newHn, errorType: newErrorType, clinic: newClinic })
                        .then(res => { if (res && res.status === 'success') { showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); fetchDataFromSheet(); } });
                }
            });
        }
        
        function deleteRecord(recordId) {
            Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!' }).then((result) => {
                if (result.isConfirmed) {
                    const originalData = [...medErrorData];
                    medErrorData = medErrorData.filter(r => r.id !== recordId);
                    updateUIAfterFetch();
                    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', 'info');
                    sendToGoogleSheets('deleteRecord', { id: recordId }).then(res => {
                        if (res && res.status === 'success') { 
                            showNotification('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); 
                            fetchDataFromSheet(); 
                        } else { 
                            medErrorData = originalData; 
                            updateUIAfterFetch(); 
                        }
                    });
                }
            });
        }

        // --- UI Updates & Pagination ---
        function updateUIAfterFetch() {
            updateRecentRecords();
            if (document.getElementById('reportPage').style.display === 'block') { 
                loadReportData(); 
            }
        }

        function prevRecentPage() { if (recentRecordsPage > 0) { recentRecordsPage--; updateRecentRecords(); } }
        function nextRecentPage() { const totalPages = Math.ceil(medErrorData.length / RECENT_ITEMS_PER_PAGE); if (recentRecordsPage < totalPages - 1) { recentRecordsPage++; updateRecentRecords(); } }
        
        function updateRecentRecords() {
            const container = document.getElementById('recentRecords');
            if (!container) return;
            const totalItems = medErrorData.length;
            const totalPages = Math.ceil(totalItems / RECENT_ITEMS_PER_PAGE) || 1;
            if (recentRecordsPage >= totalPages) recentRecordsPage = Math.max(0, totalPages - 1);
            
            const start = recentRecordsPage * RECENT_ITEMS_PER_PAGE;
            const pageItems = medErrorData.slice(start, start + RECENT_ITEMS_PER_PAGE);
            
            const pageIndicator = document.getElementById('recentPageIndicator');
            if(pageIndicator) pageIndicator.textContent = totalItems > 0 ? `‡∏´‡∏ô‡πâ‡∏≤ ${recentRecordsPage + 1} / ${totalPages}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            
            const prevBtn = document.getElementById('prevRecentBtn');
            const nextBtn = document.getElementById('nextRecentBtn');
            if(prevBtn) prevBtn.disabled = recentRecordsPage === 0;
            if(nextBtn) nextBtn.disabled = recentRecordsPage >= totalPages - 1;

            if (pageItems.length === 0) { 
                container.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; 
                return; 
            }
            container.innerHTML = pageItems.map(record => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <span class="font-medium text-gray-800">HN: ${record.hn}</span>
                        <p class="text-sm text-blue-600">${record.errorType}</p>
                        <p class="text-xs text-gray-500">${record.clinic || ''}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="text-sm text-gray-600 text-right">${record.date}<br>${record.time}</div>
                        <button onclick="editRecord(${record.id})" class="p-2 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                        <button onclick="deleteRecord(${record.id})" class="p-2 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </div>
                </div>`).join('');
        }

        // --- Report Page Logic ---
        function loadReportData() { dataTablePage = 0; filterData(); }
        function filterData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const errorType = document.getElementById('errorTypeFilter').value;
            const clinic = document.getElementById('clinicFilter').value;
            let filtered = medErrorData;
            
            if (startDate && endDate) { 
                const start = new Date(startDate).setHours(0,0,0,0); 
                const end = new Date(endDate).setHours(23,59,59,999); 
                filtered = filtered.filter(r => {
                    const recordDate = new Date(r.timestamp);
                    return recordDate >= start && recordDate <= end;
                });
            }
            if (errorType !== 'all') filtered = filtered.filter(r => r.errorType === errorType);
            if (clinic !== 'all') filtered = filtered.filter(r => r.clinic === clinic);

            currentFilteredData = filtered;
            dataTablePage = 0;
            updateSummaryCards(currentFilteredData); 
            updateChart(currentFilteredData); 
            updatePieChart(currentFilteredData);
            updateClinicChart(currentFilteredData);
            updateDataTable();
        }

        function prevDataPage() { if (dataTablePage > 0) { dataTablePage--; updateDataTable(); } }
        function nextDataPage() { const totalPages = Math.ceil(currentFilteredData.length / DATA_TABLE_ITEMS_PER_PAGE); if (dataTablePage < totalPages - 1) { dataTablePage++; updateDataTable(); } }
        
        function updateSummaryCards(data) { 
            const totalErrors = document.getElementById('totalErrors');
            if(totalErrors) totalErrors.textContent = data.length;
            
            const today = formatDateToThaiString(new Date());
            const todayErrors = document.getElementById('todayErrors');
            if(todayErrors) todayErrors.textContent = data.filter(r => r.date === today).length;
            
            const days = new Set(data.map(r => r.date)).size; 
            const avgDaily = document.getElementById('avgDaily');
            if(avgDaily) avgDaily.textContent = days > 0 ? (data.length / days).toFixed(1) : 0; 
        }

        function updateChart(data) {
            const ctx = document.getElementById('errorChart').getContext('2d');
            const dailyData = data.reduce((acc, {date}) => { acc[date] = (acc[date] || 0) + 1; return acc; }, {});
            const sortedDates = Object.keys(dailyData).sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('/');
                const [dayB, monthB, yearB] = b.split('/');
                return new Date(`${yearA - 543}-${monthA}-${dayA}`) - new Date(`${yearB - 543}-${monthB}-${dayB}`);
            });
            if (chart) chart.destroy();
            chart = new Chart(ctx, { type: 'line', data: { labels: sortedDates, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Med Error', data: sortedDates.map(date => dailyData[date]), borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }
        
        function updatePieChart(data) {
            const pieCtx = document.getElementById('pieChart')?.getContext('2d');
            if (!pieCtx) return;
            const errorCounts = data.reduce((acc, { errorType }) => { acc[errorType] = (acc[errorType] || 0) + 1; return acc; }, {});
            const labels = Object.keys(errorCounts);
            const counts = Object.values(errorCounts);
            const backgroundColors = ['#4A90E2', '#50E3C2', '#F5A623', '#D0021B', '#BD10E0', '#7ED321'];
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(pieCtx, { type: 'pie', data: { labels: labels, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: counts, backgroundColor: backgroundColors, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { family: "'Sarabun', 'Noto Sans Thai', sans-serif" } } }, datalabels: { formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return total === 0 ? '0%' : ((value / total) * 100).toFixed(1) + '%'; }, color: '#fff', font: { weight: 'bold', family: "'Sarabun', 'Noto Sans Thai', sans-serif" } } } } });
        }

        function updateClinicChart(data) {
            const barCtx = document.getElementById('clinicBarChart')?.getContext('2d');
            if (!barCtx) return;

            const clinicCounts = data.reduce((acc, { clinic }) => {
                if (clinic) {
                    acc[clinic] = (acc[clinic] || 0) + 1;
                }
                return acc;
            }, {});

            const sortedClinics = Object.entries(clinicCounts).sort(([, a], [, b]) => b - a);
            const labels = sortedClinics.map(([clinic]) => clinic);
            const counts = sortedClinics.map(([, count]) => count);
            const backgroundColors = ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B', '#3B82F6', '#EF4444', '#6366F1', '#FBBF24', '#22C55E', '#D946EF'];

            if (clinicChart) clinicChart.destroy();

            clinicChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Error',
                        data: counts,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar chart for better readability of clinic names
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1 
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#374151',
                            font: {
                                weight: 'bold',
                                family: "'Sarabun', 'Noto Sans Thai', sans-serif"
                            },
                             formatter: (value) => value > 0 ? value : ''
                        }
                    }
                }
            });
        }

        function updateDataTable() {
            const tableBody = document.getElementById('dataTable');
            if (!tableBody) return;
            const totalItems = currentFilteredData.length;
            const totalPages = Math.ceil(totalItems / DATA_TABLE_ITEMS_PER_PAGE) || 1;
            if (dataTablePage >= totalPages) dataTablePage = Math.max(0, totalPages - 1);
            
            const start = dataTablePage * DATA_TABLE_ITEMS_PER_PAGE;
            const pageItems = currentFilteredData.slice(start, start + DATA_TABLE_ITEMS_PER_PAGE);
            
            const pageIndicator = document.getElementById('dataPageIndicator');
            if(pageIndicator) pageIndicator.textContent = totalItems > 0 ? `‡∏´‡∏ô‡πâ‡∏≤ ${dataTablePage + 1} / ${totalPages}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            
            const prevBtn = document.getElementById('prevDataBtn');
            const nextBtn = document.getElementById('nextDataBtn');
            if(prevBtn) prevBtn.disabled = dataTablePage === 0;
            if(nextBtn) nextBtn.disabled = dataTablePage >= totalPages - 1;
            
            if (pageItems.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`; 
                return; 
            }
            tableBody.innerHTML = pageItems.map((r, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-4 text-sm text-gray-900">${start + index + 1}</td>
                    <td class="px-4 py-4 text-sm font-medium text-gray-900">${r.hn}</td>
                    <td class="px-4 py-4 text-sm text-blue-800">${r.errorType}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${r.clinic || ''}</td>
                    <td class="px-4 py-4 text-sm text-gray-900">${r.date}</td>
                    <td class="px-4 py-4 text-sm text-gray-900">${r.time}</td>
                    <td class="px-4 py-4 text-sm">
                        <div class="flex items-center space-x-2">
                             <button onclick="editRecord(${r.id})" class="p-2 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                            <button onclick="deleteRecord(${r.id})" class="p-2 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </td>
                </tr>`).join('');
        }
        
        // --- API Communication ---
        async function sendToGoogleSheets(action, data) {
            const payload = new URLSearchParams();
            payload.append('action', action);
            payload.append('data', JSON.stringify(data));

            try {
                const response = await fetch(scriptURL, { 
                    method: 'POST', body: payload,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                });
                const result = await response.json(); 
                if (result.status !== 'success' && result.status !== 'duplicate') { 
                    showNotification(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö Google Sheets', 'error'); 
                    console.error('GS Error:', result.message); 
                }
                return result;
            } catch (error) { 
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ', 'error'); 
                console.error('Fetch Error:', error); 
                return { status: 'error', message: error.message }; 
            }
        }

        // --- Utility Functions ---
        function exportToExcel() {
            let csvContent = "‡∏•‡∏≥‡∏î‡∏±‡∏ö,HN,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤\n";
            currentFilteredData.forEach((r, i) => { 
                csvContent += `${i + 1},"${r.hn}","${r.errorType}","${r.clinic || ''}","${r.date}","${r.time}"\n`; 
            });
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); 
            link.href = URL.createObjectURL(blob); 
            link.download = `med_error_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link);
        }

        function showLoading(isLoading) { 
            const overlay = document.getElementById('loadingOverlay');
            if(overlay) overlay.style.display = isLoading ? 'flex' : 'none'; 
        }

        function showNotification(message, type = 'info') { 
            const Toast = Swal.mixin({ 
                toast: true, position: 'top-end', showConfirmButton: false, 
                timer: 3000, timerProgressBar: true, 
                didOpen: (t) => { t.addEventListener('mouseenter', Swal.stopTimer); t.addEventListener('mouseleave', Swal.resumeTimer); } 
            }); 
            Toast.fire({ icon: type, title: message }); 
        }
    </script>
</body>
</html>
