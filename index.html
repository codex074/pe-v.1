<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏î - ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå</title>
     <link rel="icon" href="icons/icon-192x192.png" type="image/png" />
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/3B82F6/FFFFFF?text=ME">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        body { box-sizing: border-box; }
        .thai-font { font-family: 'Sarabun', 'Noto Sans Thai', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error-type-btn {
            padding: 1rem 1.5rem; margin: 0.5rem; font-size: 1.1rem;
            font-weight: 600; border: none; border-radius: 0.75rem;
            cursor: pointer; transition: all 0.2s ease-in-out;
            width: 100%; color: white;
        }
        .error-type-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .swal2-input, .swal2-select {
            border: 1px solid #d1d5db !important; border-radius: 0.5rem !important;
            font-size: 1rem !important; height: auto !important;
            padding: 0.75rem 1rem !important;
        }
        .delete-button .trash-lid { transform-origin: top right; transition: transform 0.3s ease-in-out; }
        .delete-button:hover .trash-lid { transform: rotate(-45deg) translateY(-2px) translateX(1px); }
        
        /* --- IMPROVED SEARCHABLE DROPDOWN STYLES --- */
        .clinic-search-container { position: relative; width: 100%; }
        
        #clinic-search-input { /* Target the specific input */
             padding: 0.75rem 1rem !important;
             border: 1px solid #d1d5db !important;
             border-radius: 0.5rem !important;
             box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
             width: 100%;
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        #clinic-search-input:focus {
             outline: none;
             border-color: #3b82f6 !important;
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3) !important;
        }

        .clinic-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; 
            z-index: 9999; 
            background: white; 
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            margin-top: 2px;
            max-height: 130px;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .clinic-dropdown-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            font-size: 1rem;
        }
        .clinic-dropdown-item:hover, .clinic-dropdown-item.highlighted { 
            background-color: #eef2ff;
            color: #4338ca;
            font-weight: 500;
        }
        .clinic-dropdown-empty {
             padding: 0.8rem 1rem;
             color: #6b7280;
             text-align: center;
        }

        /* --- SCANNER STYLES --- */
        #scanner-container video, #scanner-container canvas {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        #scanner-container canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }

    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full thai-font">
    
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-2 text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>
        </div>
    </div>

    <header class="bg-white shadow-lg border-b-4 border-blue-600"><div class="container mx-auto px-4 py-6 text-center"><h1 class="text-2xl md:text-3xl font-bold text-blue-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Prescribing Error</h1><p class="text-blue-600 text-sm md:text-base">‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå</p></div></header>

    <nav class="bg-blue-600 shadow-md"><div class="container mx-auto px-4"><div class="flex justify-center space-x-1"><button onclick="showPage('record')" id="recordTab" class="px-6 py-3 text-white font-medium transition-all duration-200 border-b-2 border-transparent hover:bg-blue-700 focus:outline-none">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button onclick="showPage('report')" id="reportTab" class="px-6 py-3 text-white font-medium transition-all duration-200 border-b-2 border-transparent hover:bg-blue-700 focus:outline-none">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></div></div></nav>

    <div id="recordPage" class="container mx-auto px-4 py-8 max-w-2xl"></div>
    <div id="reportPage" class="container mx-auto px-4 py-8 hidden"></div>

    <footer class="text-center py-4"><p id="syncStatus" class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p></footer>

    <script>
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(err => console.log('SW reg failed: ', err)); }); }

        const scriptURL = 'https://script.google.com/macros/s/AKfycbx3Gry5fMrN2QIlGBkWtpE3a2URRXL9cCX4fU2HU7w5FvAVDFDKfQZkbGAGtFLK74zk/exec'; 
        let medErrorData = [];
        let clinics = ['‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å', '‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó', '‡∏™‡∏π‡∏ï‡∏¥-‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä', '‡πÇ‡∏£‡∏Ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏î', '‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á', '‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô'];
        const errorTypes = ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î', '‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î'];
        let chart = null, pieChart = null, isSyncing = false;
        let recentRecordsPage = 0, dataTablePage = 0, currentFilteredData = [];
        const RECENT_ITEMS_PER_PAGE = 10, DATA_TABLE_ITEMS_PER_PAGE = 20;
        let highlightedIndex = -1; 

        Chart.register(ChartDataLabels);

        document.addEventListener('DOMContentLoaded', async () => {
            medErrorData = JSON.parse(localStorage.getItem('medErrorData')) || [];
            const storedClinics = JSON.parse(localStorage.getItem('clinics')) || [];
            if (storedClinics.length > 0) clinics = storedClinics;
            currentFilteredData = [...medErrorData];
            showPage('record'); 
            await fetchDataFromSheet(); 
        });

        async function fetchDataFromSheet() {
            if (isSyncing) return;
            isSyncing = true;
            showLoading(true);
            document.getElementById('syncStatus').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            try {
                const response = await fetch(scriptURL);
                if (!response.ok) throw new Error(`Network response: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'success') {
                    medErrorData = (result.data.pe || []).sort((a, b) => b.id - a.id);
                    clinics = result.data.clinics || clinics;
                    localStorage.setItem('medErrorData', JSON.stringify(medErrorData));
                    localStorage.setItem('clinics', JSON.stringify(clinics));
                    updateUIAfterFetch();
                    document.getElementById('syncStatus').textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleTimeString('th-TH')}`;
                } else { throw new Error(result.message); }
            } catch (error) {
                console.error('Fetch Error:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ', 'error');
                document.getElementById('syncStatus').textContent = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
            } finally { isSyncing = false; showLoading(false); }
        }
        
        function showPage(page) {
            document.getElementById('recordPage').style.display = 'none';
            document.getElementById('reportPage').style.display = 'none';
            if (page === 'record') { renderRecordPage(); document.getElementById('recordPage').style.display = 'block'; } 
            else { renderReportPage(); document.getElementById('reportPage').style.display = 'block'; loadReportData(); }
            const recordTab = document.getElementById('recordTab');
            const reportTab = document.getElementById('reportTab');
            if(recordTab) recordTab.classList.toggle('bg-blue-700', page === 'record');
            if(reportTab) reportTab.classList.toggle('bg-blue-700', page === 'report');
        }
        
        function renderRecordPage() {
            document.getElementById('recordPage').innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-6 md:p-8 fade-in relative">
                    <button onclick="showAddClinicModal()" class="absolute top-4 right-4 bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm font-bold py-2 px-3 rounded-lg transition-colors">
                        Add Clinic
                    </button>
                    <div class="text-center mb-8">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"><span class="text-2xl">üè•</span></div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Med Error</h2>
                        <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å HN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î, ‡πÅ‡∏•‡∏∞‡∏Å‡∏î Enter</p>
                    </div>
                    <form onsubmit="showErrorTypeModal(event)" class="space-y-6">
                        <div>
                            <label for="hnInput" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="hnInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg text-center" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô HN" required>
                                <button type="button" onclick="startScanner()" class="p-3 bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors" aria-label="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h14a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </form>
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-lg font-semibold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                             <div class="flex items-center space-x-2">
                                 <button id="prevRecentBtn" onclick="prevRecentPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                                 <span id="recentPageIndicator" class="text-sm text-gray-600 font-medium w-20 text-center"></span>
                                 <button id="nextRecentBtn" onclick="nextRecentPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                             </div>
                         </div>
                        <div id="recentRecords" class="space-y-2"></div>
                    </div>
                </div>`;
            updateRecentRecords();
        }

        function renderReportPage() {
             const today = new Date().toISOString().split('T')[0];
             const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
             const clinicOptions = clinics.map(c => `<option value="${c}">${c}</option>`).join('');
             const errorTypeOptions = errorTypes.map(e => `<option value="${e}">${e}</option>`).join('');
             document.getElementById('reportPage').innerHTML = `<div class="space-y-6"><div class="bg-white rounded-xl shadow-lg p-6"><div class="flex flex-col sm:flex-row justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800 mb-4 sm:mb-0">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2><button onclick="fetchDataFromSheet()" class="w-full sm:w-auto bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.186l-2.003.812a5.002 5.002 0 00-8.224-2.223L8 10l-4 4 4 4-1.774-1.774a7.002 7.002 0 01-2.186-11.899V3a1 1 0 01-1-1z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M15.999 11.232a5.002 5.002 0 00-8.224 2.223L6 10l4-4-4-4 1.774 1.774a7.002 7.002 0 0110.125 10.125L18 10l-2.001-1.232z" clip-rule="evenodd" /></svg><span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></button></div><div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end"><div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${weekAgo}"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${today}"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Error</label><select id="errorTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${errorTypeOptions}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label><select id="clinicFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${clinicOptions}</select></div><div><button onclick="filterData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">üîç ‡∏Å‡∏£‡∏≠‡∏á</button></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-3xl mb-2">üìä</div><div class="text-2xl font-bold text-blue-600" id="totalErrors">0</div><div class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</div></div><div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-3xl mb-2">üìÖ</div><div class="text-2xl font-bold text-green-600" id="todayErrors">0</div><div class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div><div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-3xl mb-2">üìà</div><div class="text-2xl font-bold text-orange-600" id="avgDaily">0</div><div class="text-gray-600">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white rounded-xl shadow-lg p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-800">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3><button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">üì• Export Excel</button></div><div class="h-80"><canvas id="errorChart"></canvas></div></div><div class="bg-white rounded-xl shadow-lg p-6"><h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Error</h3><div class="h-80 w-full max-w-md mx-auto"><canvas id="pieChart"></canvas></div></div></div><div class="bg-white rounded-xl shadow-lg p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-800">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3><div class="flex items-center space-x-2"><button id="prevDataBtn" onclick="prevDataPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><span id="dataPageIndicator" class="text-sm text-gray-600 font-medium w-20 text-center"></span><button id="nextDataBtn" onclick="nextDataPage()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50"><svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div></div><div class="overflow-x-auto"><table class="min-w-full table-auto"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="dataTable" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>`;
        }
        
        // --- SCANNER FUNCTION ---
        function startScanner() {
            Swal.fire({
                title: '‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î HN',
                html: `<div id="scanner-container" class="relative w-full h-auto"></div><p class="mt-2 text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏±‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</p>`,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                didOpen: () => {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#scanner-container'),
                            constraints: {
                                width: 480,
                                height: 320,
                                facingMode: "environment" // rear camera
                            },
                        },
                        decoder: {
                             readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "codabar_reader"]
                        },
                    }, (err) => {
                        if (err) {
                            console.error(err);
                            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
                            return;
                        }
                        Quagga.start();
                    });

                    Quagga.onDetected((result) => {
                        const code = result.codeResult.code;
                        document.getElementById('hnInput').value = code;
                        Quagga.stop();
                        Swal.close();
                        showNotification(`‡∏™‡πÅ‡∏Å‡∏ô HN ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${code}`, 'success');
                    });
                },
                willClose: () => {
                    Quagga.stop();
                }
            });
        }

        // --- DATA ACTIONS ---
        function showErrorTypeModal(event) {
            event.preventDefault();
            const hn = document.getElementById('hnInput').value.trim();
            if (!hn) return;
            Swal.fire({
                title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å HN: ${hn}`,
                html: `<p class="text-gray-600 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button onclick="showClinicModal('${hn}', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î')" class="error-type-btn bg-teal-500">‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î</button><button onclick="showClinicModal('${hn}', '‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î')" class="error-type-btn bg-pink-500">‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î</button></div>`,
                showConfirmButton: false, showCancelButton: true,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });
        }

        function showClinicModal(hn, errorType) {
            highlightedIndex = -1; 
            const outsideClickListener = (e) => {
                const container = document.getElementById('searchable-dropdown-container');
                if (container && !container.contains(e.target)) {
                    const dropdown = document.getElementById('clinic-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                }
            };
            
            const keydownListener = (e) => handleDropdownKeys(e);

            Swal.fire({
                title: `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HN: ${hn}`,
                html: `
                    <p class="text-gray-500 mb-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: <strong>${errorType}</strong></p>
                    <div id="searchable-dropdown-container" class="text-left">
                         <label for="clinic-search-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label>
                         <div class="clinic-search-container">
                            <input id="clinic-search-input" autocomplete="off" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å...">
                            <div id="clinic-dropdown" class="clinic-dropdown hidden"></div>
                        </div>
                    </div>`,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', cancelButtonText: '‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö',
                didOpen: () => {
                    const popup = Swal.getPopup();
                    const htmlContainer = Swal.getHtmlContainer();

                    if (popup) popup.style.overflow = 'visible';
                    if (htmlContainer) {
                        htmlContainer.style.overflow = 'visible';
                        htmlContainer.style.position = 'relative';
                        htmlContainer.style.zIndex = '2';
                    }

                    const input = document.getElementById('clinic-search-input');
                    input.addEventListener('focus', filterClinics);
                    input.addEventListener('keyup', (e) => { 
                        if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown' && e.key !== 'Enter') {
                            filterClinics();
                        }
                    });
                    input.addEventListener('keydown', keydownListener);
                    document.addEventListener('click', outsideClickListener);
                    filterClinics();
                    input.focus();
                },
                willClose: () => {
                    document.removeEventListener('click', outsideClickListener);
                    const input = document.getElementById('clinic-search-input');
                    if(input) input.removeEventListener('keydown', keydownListener);
                    
                    const popup = Swal.getPopup();
                    const htmlContainer = Swal.getHtmlContainer();
                    if (popup) popup.style.overflow = 'auto';
                    if (htmlContainer) {
                        htmlContainer.style.overflow = 'auto';
                        htmlContainer.style.position = '';
                        htmlContainer.style.zIndex = '';
                    }
                },
                preConfirm: () => {
                    const clinic = document.getElementById('clinic-search-input').value.trim();
                    if (!clinic) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å'); return false; }
                    return { hn, errorType, clinic };
                }
            }).then((result) => {
                if (result.isConfirmed) { saveError(result.value.hn, result.value.errorType, result.value.clinic); } 
                else if (result.dismiss === Swal.DismissReason.cancel) { showErrorTypeModal({ preventDefault: () => {} }); }
            });
        }
        
        function handleDropdownKeys(e) {
            const dropdown = document.getElementById('clinic-dropdown');
            if (!dropdown || dropdown.classList.contains('hidden')) return;

            const items = dropdown.getElementsByClassName('clinic-dropdown-item');
            if (!items.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightedIndex = (highlightedIndex + 1) % items.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightedIndex = (highlightedIndex - 1 + items.length) % items.length;
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedIndex > -1 && items[highlightedIndex]) {
                    items[highlightedIndex].click();
                } else {
                    Swal.clickConfirm();
                }
                return;
            } else {
                return;
            }
            updateHighlight(items);
        }

        function updateHighlight(items) {
             for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('highlighted');
            }
            if(items[highlightedIndex]) {
                items[highlightedIndex].classList.add('highlighted');
                items[highlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        async function showAddClinicModal() {
            const { value: newClinic } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà', input: 'text',
                inputLabel: '‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å', inputPlaceholder: '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å...',
                showCancelButton: true, confirmButtonText: '‡πÄ‡∏û‡∏¥‡πà‡∏°', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => !value && '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å'
            });
            if (newClinic && newClinic.trim()) {
                const trimmedClinic = newClinic.trim();
                if (clinics.some(c => c.toLowerCase() === trimmedClinic.toLowerCase())) {
                    showNotification('‡∏°‡∏µ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return;
                }
                showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å...', 'info');
                const result = await sendToGoogleSheets('addClinic', { clinicName: trimmedClinic });
                if (result && result.status === 'success') {
                    clinics.push(trimmedClinic);
                    clinics.sort();
                    localStorage.setItem('clinics', JSON.stringify(clinics));
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else { showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); }
            }
        }

        function filterClinics() {
            const input = document.getElementById('clinic-search-input');
            const dropdown = document.getElementById('clinic-dropdown');
            if (!input || !dropdown) return;

            highlightedIndex = -1; 
            
            const filter = input.value.toLowerCase();
            const filteredClinics = clinics.filter(c => c.toLowerCase().includes(filter));
            
            if (filteredClinics.length > 0) {
                 dropdown.innerHTML = filteredClinics.map(c => `<div class="clinic-dropdown-item" onclick="selectClinic('${c}')">${c}</div>`).join('');
            } else {
                 dropdown.innerHTML = `<div class="clinic-dropdown-empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</div>`;
            }
           
            dropdown.classList.remove('hidden');
        }

        function selectClinic(clinicName) {
            document.getElementById('clinic-search-input').value = clinicName;
            document.getElementById('clinic-dropdown').classList.add('hidden');
            Swal.clickConfirm(); 
        }
        
        function saveError(hn, errorType, clinic) {
            const now = new Date(), record = { id: now.getTime(), hn, errorType, clinic, timestamp: now.toISOString(), date: now.toLocaleDateString('th-TH'), time: now.toLocaleTimeString('th-TH') };
            medErrorData.unshift(record);
            recentRecordsPage = 0;
            updateUIAfterFetch();
            document.getElementById('hnInput').value = '';
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            sendToGoogleSheets('addRecord', record).then(result => {
                if (!result || result.status !== 'success') {
                    console.error("Sync failed, rolling back.", result);
                    if (result && result.status === 'duplicate') { Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥', text: `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Error ‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á HN: ${hn} ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß` }); } 
                    else { showNotification('‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); }
                    medErrorData = medErrorData.filter(r => r.id !== record.id);
                    updateUIAfterFetch();
                }
            });
        }
        
        function editRecord(recordId) {
            const record = medErrorData.find(r => r.id === recordId);
            if (!record) return;
            const errorOptionsHtml = errorTypes.map(type => `<option value="${type}" ${record.errorType === type ? 'selected' : ''}>${type}</option>`).join('');
            const clinicOptionsHtml = clinics.map(c => `<option value="${c}" ${record.clinic === c ? 'selected' : ''}>${c}</option>`).join('');
            Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                html: `<div class="space-y-4 p-2 text-center"><div><label for="swal-hn-input" class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN</label><input id="swal-hn-input" class="swal2-input w-full" value="${record.hn}"></div><div><label for="swal-error-type-select" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="swal-error-type-select" class="swal2-select w-full">${errorOptionsHtml}</select></div><div><label for="swal-clinic-select" class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label><select id="swal-clinic-select" class="swal2-select w-full">${clinicOptionsHtml}</select></div></div>`,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                preConfirm: () => {
                    const newHn = document.getElementById('swal-hn-input').value.trim();
                    if (!newHn) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN'); return false; }
                    return { newHn, newErrorType: document.getElementById('swal-error-type-select').value, newClinic: document.getElementById('swal-clinic-select').value };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { newHn, newErrorType, newClinic } = result.value;
                    const updatedRecord = { ...record, hn: newHn, errorType: newErrorType, clinic: newClinic };
                    medErrorData = medErrorData.map(r => r.id === recordId ? updatedRecord : r);
                    updateUIAfterFetch();
                    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...', 'info');
                    sendToGoogleSheets('editRecord', { id: recordId, hn: newHn, errorType: newErrorType, clinic: newClinic })
                        .then(success => { if (success) { showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); fetchDataFromSheet(); } });
                }
            });
        }
        
        function deleteRecord(recordId) {
            Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheet!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!' }).then((result) => {
                if (result.isConfirmed) {
                    const originalData = [...medErrorData];
                    medErrorData = medErrorData.filter(r => r.id !== recordId);
                    updateUIAfterFetch();
                    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', 'info');
                    sendToGoogleSheets('deleteRecord', { id: recordId }).then(success => {
                        if (success) { showNotification('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); fetchDataFromSheet(); } 
                        else { medErrorData = originalData; updateUIAfterFetch(); }
                    });
                }
            });
        }

        function updateUIAfterFetch() {
            updateRecentRecords();
            if (document.getElementById('reportPage').style.display === 'block') { loadReportData(); }
        }

        function prevRecentPage() { if (recentRecordsPage > 0) { recentRecordsPage--; updateRecentRecords(); } }
        function nextRecentPage() { const totalPages = Math.ceil(medErrorData.length / RECENT_ITEMS_PER_PAGE); if (recentRecordsPage < totalPages - 1) { recentRecordsPage++; updateRecentRecords(); } }
        
        function updateRecentRecords() {
            const container = document.getElementById('recentRecords');
            if (!container) return;
            const totalItems = medErrorData.length;
            const totalPages = Math.ceil(totalItems / RECENT_ITEMS_PER_PAGE) || 1;
            if (recentRecordsPage >= totalPages) { recentRecordsPage = totalPages > 0 ? totalPages - 1 : 0; }
            const start = recentRecordsPage * RECENT_ITEMS_PER_PAGE;
            const pageItems = medErrorData.slice(start, start + RECENT_ITEMS_PER_PAGE);
            const pageIndicator = document.getElementById('recentPageIndicator');
            if(pageIndicator) pageIndicator.textContent = totalItems > 0 ? `‡∏´‡∏ô‡πâ‡∏≤ ${recentRecordsPage + 1} / ${totalPages}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            const prevBtn = document.getElementById('prevRecentBtn');
            const nextBtn = document.getElementById('nextRecentBtn');
            if(prevBtn) prevBtn.disabled = recentRecordsPage === 0;
            if(nextBtn) nextBtn.disabled = recentRecordsPage >= totalPages - 1;
            if (pageItems.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; return; }
            container.innerHTML = pageItems.map(record => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><div><span class="font-medium text-gray-800">HN: ${record.hn}</span><p class="text-sm text-blue-600">${record.errorType}</p><p class="text-xs text-gray-500">${record.clinic || ''}</p></div><div class="flex items-center space-x-2"><div class="text-sm text-gray-600 text-right">${record.date}<br>${record.time.substring(0,5)}</div><button onclick="editRecord(${record.id})" class="group flex h-9 w-9 items-center justify-center rounded-xl border-2 border-indigo-700 bg-indigo-400 hover:bg-indigo-600"><div class="relative flex h-full w-full items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 48 48" height="24" width="24" class="absolute z-10"><path d="M9.7 38.3q-1.45 0-2.475-1.025Q6.2 36.25 6.2 34.8V9.7q0-1.45 1.025-2.475Q8.25 6.2 9.7 6.2h18.6L41.8 19.7v15.1q0 1.45-1.025 2.475Q39.75 38.3 38.3 38.3Zm0-3h28.6V20.8l-11.1-11.1H9.7v28.6Zm11.1-6.45 8.9-8.9-2.15-2.1-8.9 8.9ZM9.7 35.3V9.7v25.6Z"/></svg><svg fill="yellow" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="absolute h-6 w-6 text-white z-20 hidden group-hover:block transition-all group-hover:scale-125"><path clip-rule="evenodd" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" fill-rule="evenodd"></path></svg></div></button><button onclick="deleteRecord(${record.id})" class="delete-button group flex h-9 w-9 items-center justify-center rounded-xl border-2 border-red-800 bg-red-400 hover:bg-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20" class="text-white"><g class="trash-lid"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h12A2.25 2.25 0 0120.25 6v1.5H3.75V6z" /></g><g><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.5L13.5 18M10.5 7.5L9.75 18" /><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 6v12.75a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25V6h-13.5z" /></g></svg></button></div></div>`).join('');
        }

        function loadReportData() { dataTablePage = 0; filterData(); }
        function filterData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const errorType = document.getElementById('errorTypeFilter').value;
            const clinic = document.getElementById('clinicFilter').value;
            let filtered = medErrorData;
            if (startDate && endDate) { const start = new Date(startDate).setHours(0,0,0,0); const end = new Date(endDate).setHours(23,59,59,999); filtered = filtered.filter(r => new Date(r.timestamp) >= start && new Date(r.timestamp) <= end); }
            if (errorType !== 'all') { filtered = filtered.filter(r => r.errorType === errorType); }
            if (clinic !== 'all') { filtered = filtered.filter(r => r.clinic === clinic); }
            currentFilteredData = filtered;
            dataTablePage = 0;
            updateSummaryCards(currentFilteredData); updateChart(currentFilteredData); updatePieChart(currentFilteredData); updateDataTable();
        }

        function prevDataPage() { if (dataTablePage > 0) { dataTablePage--; updateDataTable(); } }
        function nextDataPage() { const totalPages = Math.ceil(currentFilteredData.length / DATA_TABLE_ITEMS_PER_PAGE); if (dataTablePage < totalPages - 1) { dataTablePage++; updateDataTable(); } }
        function updateSummaryCards(data) { document.getElementById('totalErrors').textContent = data.length; const today = new Date().toLocaleDateString('th-TH'); document.getElementById('todayErrors').textContent = data.filter(r => r.date === today).length; const days = new Set(data.map(r => r.date)).size; document.getElementById('avgDaily').textContent = days > 0 ? (data.length / days).toFixed(1) : 0; }
        function updateChart(data) {
            const ctx = document.getElementById('errorChart').getContext('2d');
            const dailyData = data.reduce((acc, {date}) => { acc[date] = (acc[date] || 0) + 1; return acc; }, {});
            const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            if (chart) chart.destroy();
            chart = new Chart(ctx, { type: 'line', data: { labels: sortedDates, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Med Error', data: sortedDates.map(date => dailyData[date]), borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }
        function updatePieChart(data) {
            const pieCtx = document.getElementById('pieChart')?.getContext('2d');
            if (!pieCtx) return;
            const errorCounts = data.reduce((acc, { errorType }) => { acc[errorType] = (acc[errorType] || 0) + 1; return acc; }, {});
            const labels = Object.keys(errorCounts), counts = Object.values(errorCounts);
            const backgroundColors = ['#4A90E2', '#50E3C2', '#F5A623', '#D0021B', '#BD10E0', '#7ED321', '#9013FE', '#F8E71C', '#FF4081', '#2962FF'];
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(pieCtx, { type: 'pie', data: { labels: labels, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: counts, backgroundColor: backgroundColors, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { family: "'Sarabun', 'Noto Sans Thai', sans-serif" } } }, datalabels: { formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); if (total === 0) return '0%'; return ((value / total) * 100).toFixed(1) + '%'; }, color: '#fff', font: { weight: 'bold', family: "'Sarabun', 'Noto Sans Thai', sans-serif" } } } } });
        }
        function updateDataTable() {
            const tableBody = document.getElementById('dataTable');
            if (!tableBody) return;
            const totalItems = currentFilteredData.length;
            const totalPages = Math.ceil(totalItems / DATA_TABLE_ITEMS_PER_PAGE) || 1;
            if (dataTablePage >= totalPages) { dataTablePage = totalItems > 0 ? totalPages - 1 : 0; }
            const start = dataTablePage * DATA_TABLE_ITEMS_PER_PAGE;
            const pageItems = currentFilteredData.slice(start, start + DATA_TABLE_ITEMS_PER_PAGE);
            const pageIndicator = document.getElementById('dataPageIndicator');
            if(pageIndicator) pageIndicator.textContent = totalItems > 0 ? `‡∏´‡∏ô‡πâ‡∏≤ ${dataTablePage + 1} / ${totalPages}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            const prevBtn = document.getElementById('prevDataBtn');
            const nextBtn = document.getElementById('nextDataBtn');
            if(prevBtn) prevBtn.disabled = dataTablePage === 0;
            if(nextBtn) nextBtn.disabled = dataTablePage >= totalPages - 1;
            if (pageItems.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`; return; }
            tableBody.innerHTML = pageItems.map((r, index) => `<tr class="hover:bg-gray-50"><td class="px-4 py-4 text-sm text-gray-900">${start + index + 1}</td><td class="px-4 py-4 text-sm font-medium text-gray-900">${r.hn}</td><td class="px-4 py-4 text-sm text-blue-800">${r.errorType}</td><td class="px-4 py-4 text-sm text-gray-500">${r.clinic || ''}</td><td class="px-4 py-4 text-sm text-gray-900">${r.date}</td><td class="px-4 py-4 text-sm text-gray-900">${r.time}</td><td class="px-4 py-4 text-sm"><div class="flex items-center space-x-2"><button onclick="editRecord(${r.id})" class="group relative flex h-9 w-9 items-center justify-center overflow-hidden rounded-xl border-2 border-indigo-700 bg-indigo-400 hover:bg-indigo-600"><div class="relative flex h-full w-full items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 48 48" height="24" width="24" class="absolute z-10"><path d="M9.7 38.3q-1.45 0-2.475-1.025Q6.2 36.25 6.2 34.8V9.7q0-1.45 1.025-2.475Q8.25 6.2 9.7 6.2h18.6L41.8 19.7v15.1q0 1.45-1.025 2.475Q39.75 38.3 38.3 38.3Zm0-3h28.6V20.8l-11.1-11.1H9.7v28.6Zm11.1-6.45 8.9-8.9-2.15-2.1-8.9 8.9ZM9.7 35.3V9.7v25.6Z"/></svg><svg fill="yellow" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="absolute h-6 w-6 text-white z-20 hidden group-hover:block transition-all group-hover:scale-125"><path clip-rule="evenodd" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" fill-rule="evenodd"></path></svg></div></button><button onclick="deleteRecord(${r.id})" class="delete-button group flex h-9 w-9 items-center justify-center rounded-xl border-2 border-red-800 bg-red-400 hover:bg-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20" class="text-white"><g class="trash-lid"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h12A2.25 2.25 0 0120.25 6v1.5H3.75V6z" /></g><g><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.5L13.5 18M10.5 7.5L9.75 18" /><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 6v12.75a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25V6h-13.5z" /></g></svg></button></div></td></tr>`).join('');
        }
        async function sendToGoogleSheets(action, data) {
            const formData = new FormData(); formData.append('action', action); formData.append('data', JSON.stringify(data));
            try {
                const response = await fetch(scriptURL, { method: 'POST', body: formData });
                const result = await response.json(); 
                if (result.status !== 'success' && result.status !== 'duplicate') { showNotification(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö Google Sheets', 'error'); console.error('GS Error:', result.message); return result; }
                return result;
            } catch (error) { showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ', 'error'); console.error('Fetch Error:', error); return { status: 'error', message: error.message }; }
        }
        function exportToExcel() {
            let filtered = [...currentFilteredData];
            let csvContent = "‡∏•‡∏≥‡∏î‡∏±‡∏ö,HN,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤\n";
            filtered.forEach((r, i) => { csvContent += `${i + 1},"${r.hn}","${r.errorType}","${r.clinic || ''}",${r.date},"${r.time}"\n`; });
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `med_error_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function showLoading(isLoading) { document.getElementById('loadingOverlay').style.display = isLoading ? 'flex' : 'none'; }
        function showNotification(message, type = 'info') { const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, didOpen: (t) => { t.addEventListener('mouseenter', Swal.stopTimer); t.addEventListener('mouseleave', Swal.resumeTimer); } }); Toast.fire({ icon: type, title: message }); }
    </script>
</body>
</html>

